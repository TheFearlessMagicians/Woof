<% include ./partials/header %>
    <div class="container" id="page">
        <% if(authorized == true){ %>
            <!-- This is for Register access. Separate register page redirects to this map.ejs where login isn't displayed. -->
            <% include ./partials/login %>
                <% } %>
                    <div class="container col-sm-12">
                        <div class="container col-sm-6" style="width: 50%;" id="mapContainer">
                            <div id="map"></div>
                            <link rel= "stylesheet" href="public/stylesheets/dogPopupStyle.css">

                              <script src = "/public/dogPopup.js"></script>
                              <script src = "/public/stylesheets/gmapsStyle.js"></script>
                            <script>
                            //dummy data.
                            function addDummyDogs(centerLatLng) {
                                let locations = [];
                                for (let i = 0; i < 20; i++)
                                    locations.push({
                                        'lat': centerLatLng['lat'] + Math.random() * 0.05,
                                        'lng': centerLatLng['lng'] + Math.random() * 0.05
                                    });
                                return locations;
                            }

                            function initMap() {
                                //GEO LOCATION
                                //var infoWindow = new google.maps.InfoWindow;

                                // Try HTML5 geolocation.
                                if (navigator.geolocation) {
                                    navigator.geolocation.getCurrentPosition(function(position) {
                                        var pos = {
                                            lat: position.coords.latitude,
                                            lng: position.coords.longitude
                                        };
                                        socket.emit('POSITION_RECEIVED', pos);
                                        var map = new google.maps.Map(document.getElementById('map'), {
                                            zoom: 13,
                                            center: pos,
                                            styles: gmapsStyle
                                        });
                                        console.log('creating a map here.');
                                        // Create an array of alphabetical characters used to label the markers.
                                        var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

                                        // Add some markers to the map.
                                        // Note: The code uses the JavaScript Array.prototype.map() method to
                                        // create an array of markers based on a given "locations" array.
                                        // The map() method here has nothing to do with the Google Maps API.
                                        // --------------------DUMMY --------------------------------
                                        var markers = addDummyDogs(pos).map(function(location, i) {
                                            return new google.maps.Marker({
                                                position: location,
                                                label: labels[i % labels.length]
                                            });
                                        });

                                        // Add a marker clusterer to manage the markers.
                                        var markerCluster = new MarkerClusterer(map, markers, { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });

                                        markers.forEach((marker)=>{google.maps.event.addListener(marker, 'click', function() {
                                                  var infowindow = new google.maps.InfoWindow({
                                                               content:  getdogPopupString('doggoName','/public/Dogs/samoyed-puppy.jpg','/dog/1','/user/1')
                                                             });
                                          //infowindow.setContent(this.content);

                                          infowindow.open(map, this);
                                        })});
                                        // infoWindow.setPosition(pos);
                                        //infoWindow.setContent('Location found.');
                                        //infoWindow.open(map);
                                        map.setCenter(pos);
                                    }, function() {

                                    });
                                } else {

                                }

                            }
                            </script>
                            <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
                            </script>
                            <script async defer src="https://maps.googleapis.com/maps/api/js?key=<%- gmapsCredential %>&callback=initMap">
                            </script>
                            <script src="/socket.io/socket.io.js"> </script>

                            <script>
                            //--------------Socket Script ---------------------------//
                            var numUsersOnline = "h2";

                            var socket = io.connect("localhost:8000");
                            socket.on('connect', function() {

                            });

                            socket.on('userConnected', function() {

                                //$(numUsersOnline).html();
                            });
                            // -------------------REAL CODE FOR MAP UPDATING ----------------------------------//
                            socket.on('DOGS_NEAR_USER', function(dogs) {
                               let mrkrs= dogs.map(function(dog, i) {
                                    return new google.maps.Marker({
                                        position: dog.location,//TODO: DIFFERENT FORMAT.
                                        label: labels[i % labels.length],
                                        dogName:dog.name,
                                        dogPicUrl:dog.picURL,
                                        dogUrl: dog.url,
                                        ownerUrl:dog.owner // TODO : get owner uri.
                                    });
                                });
                                //
                                // Add a marker clusterer to manage the markers.
                                var markerCluster = new MarkerClusterer(map, mrkrs, { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });
                                mrkrs.forEach((marker)=>{google.maps.event.addListener(marker, 'click', function() {
                                          var infowindow = new google.maps.InfoWindow({
                                                       content:  getdogPopupString(marker.dogName,marker.dogPicUrl,marker.dogUrl,marker.ownerUrl)
                                                    });

                                  infowindow.open(map, this);
                                })});
                            });
                            </script>
                        </div>
                        <div class="container col-sm-6" style="width:50%;">
                            <h2> realtime chat app.</h2>
                        </div>
                    </div>
    </div>
<% include ./partials/footer %>
