<% include ./partials/header %>
    <div class="container" id="page">

        <% if(authorized == true){ %>
        <div class="container" id="loading">
        <div class="container" id="loading-content">
              <img src="/public/loading.gif" alt="Loading" title="Loading" />
               <!-- loading gif for the map-->
        </div>
      </div>

        <form align="right" method="get" action="/logout">
            <label class="logoutLblPos">
                <input name="logoutButton" type="submit" id="logoutButton" value="Log out!">
            </label>
        </form>


                    <div class="container col-sm-12">
                        <div class="container col-sm-6" style="width: 50%;" id="mapContainer">
                            <div id="map">
                            </div>
                            <link rel= "stylesheet" href="public/stylesheets/dogPopupStyle.css">
                             <link rel= "stylesheet" href="public/stylesheets/chatStyle.css">
                              <script src = "/public/dogPopup.js"></script>
                              <script src = "/public/chatScript.js"></script>
                              <script src = "/public/stylesheets/gmapsStyle.js"></script>
                            <script>
                            //dummy data.
                            function addDummyDogs(centerLatLng) {
                                let locations = [];
                                for (let i = 0; i < 20; i++)
                                    locations.push({
                                        'lat': centerLatLng['lat'] + Math.random() * 0.05,
                                        'lng': centerLatLng['lng'] + Math.random() * 0.05
                                    });
                                return locations;
                            }

                            function initMap() {
                                //GEO LOCATION
                                //var infoWindow = new google.maps.InfoWindow;

                                // Try HTML5 geolocation.
                                if (navigator.geolocation) {
                                    navigator.geolocation.getCurrentPosition(function(position) {
                                        var pos = {
                                            lat: position.coords.latitude,
                                            lng: position.coords.longitude
                                        };
                                        
                                        socket.emit('POSITION_RECEIVED', pos);
                                        var map = new google.maps.Map(document.getElementById('map'), {
                                            zoom: 13,
                                            center: pos,
                                            styles: gmapsStyle
                                        });
                                        console.log('creating a map here.');
                                        // Create an array of alphabetical characters used to label the markers.
                                        var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

                                        // -------------------REAL CODE FOR MAP UPDATING ----------------------------------//
                                        socket.on('DOGS_NEAR_USER', function(dogs) {
                                                  console.log('dogs near user response received.');
                                                     let mrkrs= dogs.map(function(dog, i) {
                                                          return new google.maps.Marker({
                                                              position: dog.location,//TODO: DIFFERENT FORMAT.
                                                              label: labels[i % labels.length],
                                                              dogName:dog.name,
                                                              dogPicUrl:dog.picURL,
                                                              dogUrl: dog.url,
                                                              ownerUrl:dog.owner // TODO : get owner uri.
                                                          });
                                                      });
                                                      //
                                                      // Add a marker clusterer to manage the markers.
                                                      var markerCluster = new MarkerClusterer(map, mrkrs, { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });
                                                      mrkrs.forEach((marker)=>{google.maps.event.addListener(marker, 'click', function() {
                                                                var infowindow = new google.maps.InfoWindow({
                                                                             content:  getdogPopupString(marker.dogName,marker.dogPicUrl,marker.dogUrl,marker.ownerUrl)
                                                                          });

                                                        infowindow.open(map, this);
                                                      })
                                                  });

                                        });
                                        google.maps.event.addListener(map, 'tilesloaded', function(){
                                              //document.getElementById('loading').innerHTML = '';
                                              $(`#loading`).css("display", "none");
                                        });


                                        map.setCenter(pos);
                                    }, function() {

                                    });
                                } else {

                                }

                            }


                            //Loading screen for map.

                            </script>
                            <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
                            </script>
                            <script async defer src="https://maps.googleapis.com/maps/api/js?key=<%- gmapsCredential %>&callback=initMap">
                            </script>
                            <script src="/socket.io/socket.io.js"> </script>

                            <script>
                            //--------------Socket Script ---------------------------//
                            var numUsersOnline = "h2";

                            var socket = io.connect("localhost:8000");
                            socket.on('connect', function() {

                            });


                            socket.on('userConnected', function() {

                                //$(numUsersOnline).html();
                            });


                            </script>
                        </div>
                        <!-- CHAT WINDOW -------->
                        <div class="container col-sm-6" style="width:50%;">

                            <div class="chat_window">
                                  <div class="top_menu">
                                      <!--<div class="buttons">
                                          <div class="button close"></div>
                                          <div class="button minimize"></div>
                                          <div class="button maximize"></div>
                                </div>-->
                                      <div class="title">Chat</div>
                                  </div>
                                  <ul class="messages"></ul>
                                  <div class="bottom_wrapper clearfix">
                                      <div class="message_input_wrapper"><input class="message_input" placeholder="Type your message here..." /></div>
                                      <div class="send_message">
                                          <div class="icon"></div>
                                          <div class="text">Send</div>
                                      </div>
                                  </div>
                              </div>
                              <div class="message_template">
                                  <li class="message">
                                      <div class="avatar"></div>
                                      <div class="text_wrapper">
                                          <div class="text"></div>
                                      </div>
                                  </li>
                              </div>
                        </div>
                    </div>
    </div>
    <!-- chat script -->
<script src= '/public/chatScript.js'></script>
<% include ./partials/footer %>

   <% } %>
